{{ 'scrolling-testimonials.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign heading = section.settings.heading
  assign subheading = section.settings.subheading
  assign footer_text = section.settings.footer_text
  assign background_color = section.settings.background_color
  assign text_color = section.settings.text_color
  assign autoplay = section.settings.autoplay
  assign autoplay_speed = section.settings.autoplay_speed | times: 1000
  assign indicator_color = section.settings.indicator_color
  assign indicator_active_color = section.settings.indicator_active_color
-%}

<div class="scrolling-testimonials" style="background-color: {{ background_color }}; color: {{ text_color }};">
  <div class="scrolling-testimonials__header">
    {% if heading != blank %}
      <h2 class="scrolling-testimonials__heading">{{ heading }}</h2>
    {% endif %}
    {% if subheading != blank %}
      <div class="scrolling-testimonials__subheading">{{ subheading }}</div>
    {% endif %}
  </div>

  <div class="scrolling-testimonials__slider-container">
    <button type="button" class="scrolling-testimonials__nav scrolling-testimonials__nav--prev" aria-label="上一个">
      {% render 'svg-icons', icon: 'chevron-left' %}
    </button>
    
    <div class="scrolling-testimonials__slider">
      {% for block in section.blocks %}
        {%- liquid
          assign image = block.settings.image
          assign heading = block.settings.heading
          assign text = block.settings.text
        -%}
        <div class="scrolling-testimonials__slide" {{ block.shopify_attributes }}>
          <div class="scrolling-testimonials__slide-inner">
            {% if image != blank %}
              <div class="scrolling-testimonials__image-container">
                {% render 'responsive-image', image: image, sizes: '600x' %}
              </div>
            {% endif %}
            
            <div class="scrolling-testimonials__content">
              {% if heading != blank %}
                <h3 class="scrolling-testimonials__slide-heading">{{ heading }}</h3>
              {% endif %}
              {% if text != blank %}
                <div class="scrolling-testimonials__text">{{ text }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    
    <button type="button" class="scrolling-testimonials__nav scrolling-testimonials__nav--next" aria-label="下一个">
      {% render 'svg-icons', icon: 'chevron-right' %}
    </button>
    
    <div class="scrolling-testimonials__indicators">
      {% for block in section.blocks %}
        <button class="scrolling-testimonials__indicator{% if forloop.first %} active{% endif %}" data-index="{{ forloop.index0 }}" aria-label="转到滑块 {{ forloop.index }}" style="background-color: {{ indicator_color }}"></button>
      {% endfor %}
    </div>
  </div>

  {% if footer_text != blank %}
    <div class="scrolling-testimonials__footer">
      <div class="scrolling-testimonials__footer-text">{{ footer_text }}</div>
    </div>
  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('.scrolling-testimonials__slider');
    const slides = document.querySelectorAll('.scrolling-testimonials__slide');
    const prevBtn = document.querySelector('.scrolling-testimonials__nav--prev');
    const nextBtn = document.querySelector('.scrolling-testimonials__nav--next');
    const indicators = document.querySelectorAll('.scrolling-testimonials__indicator');
    let currentIndex = 0;
    let autoplayInterval;
    const autoplayDelay = {{ autoplay_speed }};
    const shouldAutoplay = {{ autoplay | json }};
    
    function updateSlider() {
      const slideWidth = slides[0].offsetWidth;
      container.style.transform = `translateX(-${currentIndex * slideWidth}px)`;
      
      // 更新指示器状态
      indicators.forEach((indicator, index) => {
        if (index === currentIndex) {
          indicator.classList.add('active');
          indicator.style.backgroundColor = '{{ indicator_active_color }}';
        } else {
          indicator.classList.remove('active');
          indicator.style.backgroundColor = '{{ indicator_color }}';
        }
      });
    }
    
    function goToSlide(index) {
      if (index < 0) {
        currentIndex = slides.length - 1;
      } else if (index >= slides.length) {
        currentIndex = 0;
      } else {
        currentIndex = index;
      }
      updateSlider();
    }
    
    function startAutoplay() {
      stopAutoplay();
      autoplayInterval = setInterval(() => {
        goToSlide(currentIndex + 1);
      }, autoplayDelay);
    }
    
    function stopAutoplay() {
      if (autoplayInterval) {
        clearInterval(autoplayInterval);
      }
    }
    
    prevBtn.addEventListener('click', () => {
      goToSlide(currentIndex - 1);
      stopAutoplay();
    });
    
    nextBtn.addEventListener('click', () => {
      goToSlide(currentIndex + 1);
      stopAutoplay();
    });
    
    // 点击指示器切换滑块
    indicators.forEach(indicator => {
      indicator.addEventListener('click', () => {
        const index = parseInt(indicator.dataset.index);
        goToSlide(index);
        stopAutoplay();
      });
    });
    
    // 初始化
    updateSlider();
    if (shouldAutoplay) {
      startAutoplay();
    }
    
    // 窗口大小改变时重新计算
    window.addEventListener('resize', updateSlider);
    
    // 鼠标悬停时暂停自动播放
    const sliderContainer = document.querySelector('.scrolling-testimonials__slider-container');
    sliderContainer.addEventListener('mouseenter', stopAutoplay);
    sliderContainer.addEventListener('mouseleave', startAutoplay);
  });
</script>

{% schema %}
{
  "name": "滚动展示",
  "class": "section-scrolling-testimonials",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "标题",
      "default": "精彩内容展示"
    },
    {
      "type": "richtext",
      "id": "subheading",
      "label": "副标题",
      "default": "<p>在这里添加您的副标题文本</p>"
    },
    {
      "type": "richtext",
      "id": "footer_text",
      "label": "底部文本",
      "default": "<p>在这里添加底部文本内容</p>"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "背景颜色",
      "default": "#f8f8f8"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "文字颜色",
      "default": "#333333"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "自动播放",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "label": "自动播放速度（秒）",
      "min": 3,
      "max": 10,
      "step": 1,
      "default": 5
    },
    {
      "type": "color",
      "id": "indicator_color",
      "label": "指示器颜色",
      "default": "rgba(255, 255, 255, 0.5)"
    },
    {
      "type": "color",
      "id": "indicator_active_color",
      "label": "指示器激活颜色",
      "default": "#ffffff"
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "滑块",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "图片"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "标题",
          "default": "滑块标题"
        },
        {
          "type": "richtext",
          "id": "text",
          "label": "文本内容",
          "default": "<p>在这里添加您的文本内容</p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "滚动展示",
      "blocks": [
        {
          "type": "slide"
        },
        {
          "type": "slide"
        },
        {
          "type": "slide"
        }
      ]
    }
  ]
}
{% endschema %} 